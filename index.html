<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #000000;
      color: #dcddde;
      overflow: hidden;
      height: 100vh;
    }
    #auth {
      max-width: 400px;
      margin: 50px auto;
      background: #1a1a1a;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(255,0,0,0.2);
      border: 1px solid #2a2a2a;
    }
    #auth h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #ff3333;
      text-align: center;
    }
    #auth input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #333;
      border-radius: 5px;
      background: #0a0a0a;
      color: #e0e0e0;
    }
    #auth input:focus {
      outline: none;
      border-color: #ff3333;
    }
    #auth button {
      width: 48%;
      padding: 10px;
      margin: 5px 1%;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    #loginBtn {
      background: #ff3333;
      color: white;
    }
    #loginBtn:hover {
      background: #ff5555;
    }
    #registerBtn {
      background: #333;
      color: white;
      border: 1px solid #ff3333;
    }
    #registerBtn:hover {
      background: #ff3333;
    }
    #chat {
      display: none;
      height: 100vh;
      flex-direction: row;
    }
    .sidebar {
      width: 280px;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #0a0a0a;
    }
    .sidebar-header {
      padding: 15px;
      background: #0a0a0a;
      border-bottom: 1px solid #000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-header h3 {
      color: #ff3333;
      font-size: 16px;
    }
    .new-dm-btn {
      background: #ff3333;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.3s;
    }
    .new-dm-btn:hover {
      background: #ff5555;
    }
    .conversations-container {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .conversation-item {
      padding: 10px 12px;
      margin: 2px 0;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #b9bbbe;
    }
    .conversation-item:hover {
      background: #2a2a2a;
      color: #dcddde;
    }
    .conversation-item.active {
      background: #ff3333;
      color: white;
    }
    .conversation-info {
      flex: 1;
      min-width: 0;
    }
    .conversation-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .conversation-members {
      font-size: 12px;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .delete-conversation {
      background: transparent;
      color: #b9bbbe;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      opacity: 0;
    }
    .conversation-item:hover .delete-conversation {
      opacity: 1;
    }
    .delete-conversation:hover {
      background: #ff3333;
      color: white;
    }
    .conversation-item.active .delete-conversation {
      color: white;
      opacity: 1;
    }
    .user-info {
      padding: 15px;
      background: #0a0a0a;
      border-top: 1px solid #000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .username-display {
      color: #ff3333;
      font-weight: 600;
      font-size: 14px;
    }
    .logout-btn {
      background: #333;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }
    .logout-btn:hover {
      background: #ff3333;
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0a0a0a;
    }
    .chat-header {
      height: 60px;
      padding: 0 20px;
      background: #1a1a1a;
      border-bottom: 1px solid #0a0a0a;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .chat-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }
    .chat-members {
      font-size: 13px;
      color: #b9bbbe;
    }
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .message {
      margin-bottom: 16px;
      padding: 8px 12px;
      background: #1a1a1a;
      border-radius: 6px;
      border-left: 3px solid #ff3333;
    }
    .message.own {
      border-left-color: #cc0000;
      background: #2a0a0a;
    }
    .message-author {
      font-weight: 600;
      font-size: 14px;
      color: #ff3333;
      margin-bottom: 4px;
    }
    .message.own .message-author {
      color: #ff5555;
    }
    .message-text {
      font-size: 14px;
      color: #dcddde;
      word-wrap: break-word;
    }
    .message-input-container {
      padding: 20px;
      background: #1a1a1a;
    }
    .message-input-wrapper {
      display: flex;
      gap: 10px;
      background: #0a0a0a;
      padding: 10px;
      border-radius: 8px;
    }
    .message-input-wrapper input {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      color: #dcddde;
      font-size: 14px;
    }
    .message-input-wrapper input:focus {
      outline: none;
    }
    .message-input-wrapper input::placeholder {
      color: #72767d;
    }
    .send-btn {
      padding: 10px 20px;
      background: #ff3333;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    .send-btn:hover {
      background: #ff5555;
    }
    .send-btn:disabled {
      background: #333;
      cursor: not-allowed;
    }
    .empty-state {
      text-align: center;
      padding: 60px 40px;
      color: #72767d;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #b9bbbe;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #1a1a1a;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(255,0,0,0.5);
      border: 1px solid #2a2a2a;
      max-width: 500px;
      width: 90%;
    }
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 16px;
      color: #fff;
    }
    .modal-content {
      margin-bottom: 20px;
    }
    .modal-input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #333;
      border-radius: 5px;
      background: #0a0a0a;
      color: #dcddde;
      font-size: 14px;
    }
    .modal-input:focus {
      outline: none;
      border-color: #ff3333;
    }
    .modal-label {
      display: block;
      margin-bottom: 8px;
      color: #b9bbbe;
      font-size: 13px;
      font-weight: 600;
    }
    .user-select-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #333;
      border-radius: 5px;
      background: #0a0a0a;
      margin-top: 8px;
    }
    .user-select-item {
      padding: 10px;
      display: flex;
      align-items: center;
      cursor: pointer;
      border-bottom: 1px solid #1a1a1a;
    }
    .user-select-item:hover {
      background: #2a2a2a;
    }
    .user-select-item:last-child {
      border-bottom: none;
    }
    .user-checkbox {
      margin-right: 10px;
      cursor: pointer;
    }
    .selected-users {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .selected-user-tag {
      background: #ff3333;
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .remove-user {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      line-height: 1;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    .modal-btn.cancel {
      background: #333;
      color: white;
    }
    .modal-btn.cancel:hover {
      background: #444;
    }
    .modal-btn.confirm {
      background: #ff3333;
      color: white;
    }
    .modal-btn.confirm:hover {
      background: #ff5555;
    }
    .modal-btn.create {
      background: #ff3333;
      color: white;
    }
    .modal-btn.create:hover {
      background: #ff5555;
    }
    .modal-btn.create:disabled {
      background: #333;
      cursor: not-allowed;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1a1a1a;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(255,0,0,0.4);
      border: 1px solid #2a2a2a;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 250px;
      max-width: 400px;
      animation: slideIn 0.3s ease;
      color: #dcddde;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .toast.success { border-left: 4px solid #ff3333; }
    .toast.error { border-left: 4px solid #ff6666; }
    .toast.warning { border-left: 4px solid #ff9933; }
    .toast.info { border-left: 4px solid #ff3333; }
    .toast-icon {
      font-size: 24px;
      color: #ff3333;
    }
    .toast-message { flex: 1; }
    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 24px;
      height: 24px;
    }
    .toast-close:hover { color: #ff3333; }
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: #0a0a0a;
    }
    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #ff3333;
    }
  </style>
</head>
<body>
  <div id="auth">
    <h2>Welcome</h2>
    <input id="username" placeholder="Username" />
    <input id="password" type="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
  </div>
  
  <div id="chat">
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Direct Messages</h3>
        <button class="new-dm-btn" id="newDmBtn">+ New</button>
      </div>
      <div class="conversations-container" id="conversationsList">
        <div class="empty-state">
          <div class="empty-state-title">No conversations yet</div>
          <div>Start a DM or create a group</div>
        </div>
      </div>
      <div class="user-info">
        <div class="username-display" id="usernameDisplay"></div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
    
    <div class="main-content">
      <div class="chat-header" id="chatHeader" style="display:none;">
        <div>
          <div class="chat-title" id="chatTitle"></div>
          <div class="chat-members" id="chatMembers"></div>
        </div>
      </div>
      <div class="messages-container" id="messagesContainer">
        <div class="empty-state">
          <div class="empty-state-title">hola</div>
          <div>Select a conversation or start a new one</div>
        </div>
      </div>
      <div class="message-input-container" id="messageInputContainer" style="display:none;">
        <div class="message-input-wrapper">
          <input id="messageInput" placeholder="Type a message..." disabled />
          <button id="sendBtn" class="send-btn" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDocs, where, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzt2lJe_cIK_U7Uh88Wun73dG7GxQMYh4",
      authDomain: "tankaportalv2.firebaseapp.com",
      projectId: "tankaportalv2",
      storageBucket: "tankaportalv2.firebasestorage.app",
      messagingSenderId: "187174097219",
      appId: "1:187174097219:web:0987e83cd8e8d2c101dff6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    let currentConversation = null;
    let currentDMListener = null;
    let conversationsListener = null;
    let conversations = new Map();
    let allUsers = [];

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icons = { success: 'âœ“', error: 'âœ•', warning: 'âš ', info: 'â„¹' };
      toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-message">${message}</div>
        <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function fakeEmail(username) {
      return `${username}@chatapp.com`;
    }

    function getConversationId(users) {
      return users.sort().join("_");
    }

    async function loadAllUsers() {
      const usersRef = collection(db, "users");
      const snapshot = await getDocs(usersRef);
      allUsers = [];
      snapshot.forEach(docSnap => {
        const username = docSnap.data().username;
        if (username !== auth.currentUser?.displayName) {
          allUsers.push(username);
        }
      });
    }

    document.getElementById("registerBtn").onclick = async () => {
      try {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        if (!username || !password) {
          showToast("Please enter username and password", "error");
          return;
        }
        if (password.length < 6) {
          showToast("Password must be at least 6 characters", "error");
          return;
        }
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("username", "==", username));
        const snap = await getDocs(q);
        if (!snap.empty) {
          showToast("Username already taken", "error");
          return;
        }
        const email = fakeEmail(username);
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCredential.user, { displayName: username });
        await setDoc(doc(db, "users", userCredential.user.uid), { username });
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
      } catch (error) {
        showToast(error.message, "error");
      }
    };

    document.getElementById("loginBtn").onclick = async () => {
      try {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        if (!username || !password) {
          showToast("Please enter username and password", "error");
          return;
        }
        const email = fakeEmail(username);
        await signInWithEmailAndPassword(auth, email, password);
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
      } catch (error) {
        showToast("Invalid username or password", "error");
      }
    };

    document.getElementById("logoutBtn").onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("auth").style.display = "none";
        document.getElementById("chat").style.display = "flex";
        document.getElementById("usernameDisplay").textContent = user.displayName;
        loadConversations();
        loadAllUsers();
      } else {
        document.getElementById("auth").style.display = "block";
        document.getElementById("chat").style.display = "none";
        if (currentDMListener) currentDMListener();
        if (conversationsListener) conversationsListener();
        conversations.clear();
        currentConversation = null;
        allUsers = [];
      }
    });

    function loadConversations() {
      const currentUser = auth.currentUser.displayName;
      const dmsRef = collection(db, "dms");
      conversationsListener = onSnapshot(dmsRef, async snapshot => {
        conversations.clear();
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          if (data.members && data.members.includes(currentUser)) {
            conversations.set(docSnap.id, {
              id: docSnap.id,
              members: data.members,
              groupName: data.groupName || null,
              lastMessage: data.lastMessage || null
            });
          }
        }
        updateConversationsList();
      });
    }

    function updateConversationsList() {
      const container = document.getElementById("conversationsList");
      container.innerHTML = "";
      if (conversations.size === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ’¬</div>
            <div class="empty-state-title">No conversations yet</div>
            <div>Start a DM or create a group!</div>
          </div>
        `;
        return;
      }
      conversations.forEach(conv => {
        const div = document.createElement("div");
        div.className = "conversation-item";
        if (currentConversation === conv.id) div.classList.add("active");
        
        const currentUser = auth.currentUser.displayName;
        const otherMembers = conv.members.filter(m => m !== currentUser);
        const displayName = conv.groupName || otherMembers.join(", ");
        const isGroup = conv.members.length > 2;
        
        div.innerHTML = `
          <div class="conversation-info">
            <div class="conversation-name">${isGroup ? 'ðŸ‘¥ ' : ''}${displayName}</div>
            <div class="conversation-members">${conv.members.length} member${conv.members.length > 1 ? 's' : ''}</div>
          </div>
          <button class="delete-conversation">Ã—</button>
        `;
        
        div.querySelector(".conversation-info").onclick = () => selectConversation(conv.id);
        div.querySelector(".delete-conversation").onclick = (e) => {
          e.stopPropagation();
          deleteConversation(conv.id);
        };
        
        container.appendChild(div);
      });
    }

    function selectConversation(conversationId) {
      currentConversation = conversationId;
      const conv = conversations.get(conversationId);
      const currentUser = auth.currentUser.displayName;
      const otherMembers = conv.members.filter(m => m !== currentUser);
      const displayName = conv.groupName || otherMembers.join(", ");
      const isGroup = conv.members.length > 2;
      
      document.getElementById("chatHeader").style.display = "flex";
      document.getElementById("chatTitle").textContent = (isGroup ? 'ðŸ‘¥ ' : '') + displayName;
      document.getElementById("chatMembers").textContent = conv.members.join(", ");
      document.getElementById("messageInputContainer").style.display = "block";
      document.getElementById("messageInput").disabled = false;
      document.getElementById("sendBtn").disabled = false;
      
      updateConversationsList();
      startDM(conversationId);
    }

    function startDM(conversationId) {
      if (currentDMListener) currentDMListener();
      const q = query(collection(db, "dms", conversationId, "messages"), orderBy("createdAt", "asc"));
      currentDMListener = onSnapshot(q, snapshot => {
        const container = document.getElementById("messagesContainer");
        container.innerHTML = "";
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement("div");
          div.className = "message";
          if (data.from === auth.currentUser?.displayName) {
            div.classList.add("own");
          }
          div.innerHTML = `
            <div class="message-author">${data.from}</div>
            <div class="message-text">${data.text}</div>
          `;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      });
    }

    document.getElementById("sendBtn").onclick = sendMessage;
    document.getElementById("messageInput").onkeypress = (e) => {
      if (e.key === 'Enter') sendMessage();
    };

    async function sendMessage() {
      const text = document.getElementById("messageInput").value.trim();
      if (!currentConversation || !text) return;
      const conv = conversations.get(currentConversation);
      try {
        await setDoc(doc(db, "dms", currentConversation), {
          members: conv.members,
          groupName: conv.groupName || null,
          lastMessage: text,
          lastMessageTime: serverTimestamp()
        }, { merge: true });
        await addDoc(collection(db, "dms", currentConversation, "messages"), {
          from: auth.currentUser.displayName,
          text,
          createdAt: serverTimestamp()
        });
        document.getElementById("messageInput").value = "";
      } catch (error) {
        showToast("Failed to send message", "error");
      }
    }

    document.getElementById("newDmBtn").onclick = showNewDmModal;

    function showNewDmModal() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Create New Conversation</div>
          <div class="modal-content">
            <label class="modal-label">Group Name (optional for groups)</label>
            <input type="text" class="modal-input" id="groupNameInput" placeholder="Leave empty for DM" />
            
            <label class="modal-label">Select Users</label>
            <input type="text" class="modal-input" id="userSearchInput" placeholder="Search users..." />
            <div class="user-select-list" id="userSelectList"></div>
            
            <div class="selected-users" id="selectedUsersList"></div>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn create" id="createConvBtn">Create</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      const selectedUsers = new Set();
      const userSearchInput = overlay.querySelector('#userSearchInput');
      const userSelectList = overlay.querySelector('#userSelectList');
      const selectedUsersList = overlay.querySelector('#selectedUsersList');
      
      function updateUserList(searchTerm = '') {
        userSelectList.innerHTML = '';
        const filtered = allUsers.filter(u => 
          u.toLowerCase().includes(searchTerm.toLowerCase()) && !selectedUsers.has(u)
        );
        filtered.forEach(username => {
          const div = document.createElement('div');
          div.className = 'user-select-item';
          div.innerHTML = `
            <input type="checkbox" class="user-checkbox" />
            <span>${username}</span>
          `;
          div.onclick = () => {
            selectedUsers.add(username);
            updateSelectedUsers();
            updateUserList(userSearchInput.value);
          };
          userSelectList.appendChild(div);
        });
        if (filtered.length === 0) {
          userSelectList.innerHTML = '<div style="padding:10px;color:#72767d;text-align:center;">No users found</div>';
        }
      }
      
      function updateSelectedUsers() {
        selectedUsersList.innerHTML = '';
        selectedUsers.forEach(username => {
          const tag = document.createElement('div');
          tag.className = 'selected-user-tag';
          tag.innerHTML = `
            ${username}
            <button class="remove-user">Ã—</button>
          `;
          tag.querySelector('.remove-user').onclick = () => {
            selectedUsers.delete(username);
            updateSelectedUsers();
            updateUserList(userSearchInput.value);
          };
          selectedUsersList.appendChild(tag);
        });
      }
      
      userSearchInput.oninput = (e) => updateUserList(e.target.value);
      updateUserList();
      
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('#createConvBtn').onclick = async () => {
        if (selectedUsers.size === 0) {
          showToast("Please select at least one user", "warning");
          return;
        }
        const groupName = overlay.querySelector('#groupNameInput').value.trim();
        const members = [auth.currentUser.displayName, ...Array.from(selectedUsers)];
        const conversationId = getConversationId(members);
        
        try {
          await setDoc(doc(db, "dms", conversationId), {
            members,
            groupName: members.length > 2 ? (groupName || null) : null,
            createdAt: serverTimestamp()
          });
          overlay.remove();
          showToast("Conversation created!", "success");
        } catch (error) {
          showToast("Failed to create conversation", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    function deleteConversation(conversationId) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Delete Conversation</div>
          <div class="modal-content">
            <p style="color:#b9bbbe;">This will remove all messages. Are you sure?</p>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn confirm">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('.confirm').onclick = async () => {
        try {
          const messagesRef = collection(db, "dms", conversationId, "messages");
          const messagesSnap = await getDocs(messagesRef);
          await Promise.all(messagesSnap.docs.map(d => deleteDoc(d.ref)));
          await deleteDoc(doc(db, "dms", conversationId));
          if (currentConversation === conversationId) {
            currentConversation = null;
            document.getElementById("chatHeader").style.display = "none";
            document.getElementById("messageInputContainer").style.display = "none";
            document.getElementById("messagesContainer").innerHTML = `
              <div class="empty-state">
                <div class="empty-state-title">hola</div>
                <div>Select a conversation or start a new one</div>
              </div>
            `;
          }
          overlay.remove();
          showToast("Conversation deleted", "success");
        } catch (error) {
          showToast("Failed to delete conversation", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }
  </script>
</body>
</html>
