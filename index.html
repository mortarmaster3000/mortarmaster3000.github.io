<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App v2</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #000000;
      color: #dcddde;
      overflow: hidden;
      height: 100vh;
    }
    #auth {
      max-width: 400px;
      margin: 50px auto;
      background: #1a1a1a;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(255,0,0,0.2);
      border: 1px solid #2a2a2a;
    }
    #auth h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #ff3333;
      text-align: center;
    }
    #auth input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #333;
      border-radius: 5px;
      background: #0a0a0a;
      color: #e0e0e0;
    }
    #auth input:focus {
      outline: none;
      border-color: #ff3333;
    }
    #auth button {
      width: 48%;
      padding: 10px;
      margin: 5px 1%;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    #loginBtn {
      background: #ff3333;
      color: white;
    }
    #loginBtn:hover {
      background: #ff5555;
    }
    #registerBtn {
      background: #333;
      color: white;
      border: 1px solid #ff3333;
    }
    #registerBtn:hover {
      background: #ff3333;
    }
    #chat {
      display: none;
      height: 100vh;
      flex-direction: row;
    }
    .sidebar {
      width: 280px;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #0a0a0a;
    }
    .sidebar-header {
      padding: 15px;
      background: #0a0a0a;
      border-bottom: 1px solid #000;
    }
    .sidebar-header h3 {
      color: #ff3333;
      font-size: 16px;
      margin-bottom: 10px;
    }
    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .nav-btn {
      background: transparent;
      color: #b9bbbe;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      text-align: left;
      font-weight: 500;
    }
    .nav-btn:hover {
      background: #2a2a2a;
      color: #dcddde;
    }
    .nav-btn.active {
      background: #ff3333;
      color: white;
    }
    .conversations-container {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .conversation-item {
      padding: 10px 12px;
      margin: 2px 0;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #b9bbbe;
    }
    .conversation-item:hover {
      background: #2a2a2a;
      color: #dcddde;
    }
    .conversation-item.active {
      background: #ff3333;
      color: white;
    }
    .conversation-info {
      flex: 1;
      min-width: 0;
    }
    .conversation-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .conversation-members {
      font-size: 12px;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .delete-conversation {
      background: transparent;
      color: #b9bbbe;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      opacity: 0;
    }
    .conversation-item:hover .delete-conversation {
      opacity: 1;
    }
    .delete-conversation:hover {
      background: #ff3333;
      color: white;
    }
    .conversation-item.active .delete-conversation {
      color: white;
      opacity: 1;
    }
    .message-image {
      max-width: 300px;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .message-image:hover {
      transform: scale(1.02);
    }
    .message-file {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      background: #2a2a2a;
      border-radius: 6px;
      margin-top: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .message-file:hover {
      background: #333;
    }
    .file-icon {
      font-size: 24px;
    }
    .file-info {
      display: flex;
      flex-direction: column;
    }
    .file-name {
      font-weight: 500;
      color: #dcddde;
    }
    .file-size {
      font-size: 12px;
      color: #72767d;
    }
    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      cursor: pointer;
      color: #b9bbbe;
      transition: color 0.3s;
    }
    .file-input-label:hover {
      color: #ff3333;
    }
    .file-input-label input {
      display: none;
    }
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      cursor: pointer;
    }
    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    .user-info {
      padding: 15px;
      background: #0a0a0a;
      border-top: 1px solid #000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .username-display {
      color: #ff3333;
      font-weight: 600;
      font-size: 14px;
    }
    .logout-btn {
      background: #333;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }
    .logout-btn:hover {
      background: #ff3333;
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0a0a0a;
      overflow: hidden;
    }
    #chatView {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .chat-header {
      height: 60px;
      padding: 0 20px;
      background: #1a1a1a;
      border-bottom: 1px solid #0a0a0a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .chat-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }
    .chat-members {
      font-size: 13px;
      color: #b9bbbe;
    }
    .messages-container {
      flex: 1;
      overflow-y: scroll !important;
      overflow-x: hidden;
      padding: 20px;
      max-height: calc(100vh - 180px);
      min-height: 200px;
    }
    .message {
      margin-bottom: 16px;
      padding: 8px 12px;
      background: #1a1a1a;
      border-radius: 6px;
      border-left: 3px solid #ff3333;
    }
    .message.own {
      border-left-color: #cc0000;
      background: #2a0a0a;
    }
    .message-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }
    .message-author {
      font-weight: 600;
      font-size: 14px;
      color: #ff3333;
    }
    .message.own .message-author {
      color: #ff5555;
    }
    .message-timestamp {
      font-size: 11px;
      color: #72767d;
    }
    .message-text {
      font-size: 14px;
      color: #dcddde;
      word-wrap: break-word;
    }
    .message-input-container {
      padding: 20px;
      background: #1a1a1a;
      flex-shrink: 0;
    }
    .message-input-wrapper {
      display: flex;
      gap: 10px;
      background: #0a0a0a;
      padding: 10px;
      border-radius: 8px;
    }
    .message-input-wrapper input {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      color: #dcddde;
      font-size: 14px;
    }
    .message-input-wrapper input:focus {
      outline: none;
    }
    .message-input-wrapper input::placeholder {
      color: #72767d;
    }
    .send-btn {
      padding: 10px 16px;
      background: #ff3333;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .send-btn:hover {
      background: #ff5555;
    }
    .send-btn:disabled {
      background: #333;
      cursor: not-allowed;
    }
    .empty-state {
      text-align: center;
      padding: 60px 40px;
      color: #72767d;
    }
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #b9bbbe;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #1a1a1a;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(255,0,0,0.5);
      border: 1px solid #2a2a2a;
      max-width: 500px;
      width: 90%;
    }
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 16px;
      color: #fff;
    }
    .modal-content {
      margin-bottom: 20px;
    }
    .modal-input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #333;
      border-radius: 5px;
      background: #0a0a0a;
      color: #dcddde;
      font-size: 14px;
    }
    .modal-input:focus {
      outline: none;
      border-color: #ff3333;
    }
    .modal-label {
      display: block;
      margin-bottom: 8px;
      color: #b9bbbe;
      font-size: 13px;
      font-weight: 600;
    }
    .user-select-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #333;
      border-radius: 5px;
      background: #0a0a0a;
      margin-top: 8px;
    }
    .user-select-item {
      padding: 10px;
      display: flex;
      align-items: center;
      cursor: pointer;
      border-bottom: 1px solid #1a1a1a;
    }
    .user-select-item:hover {
      background: #2a2a2a;
    }
    .user-select-item:last-child {
      border-bottom: none;
    }
    .user-checkbox {
      margin-right: 10px;
      cursor: pointer;
    }
    .selected-users {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .selected-user-tag {
      background: #ff3333;
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .remove-user {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      line-height: 1;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    .modal-btn.cancel {
      background: #333;
      color: white;
    }
    .modal-btn.cancel:hover {
      background: #444;
    }
    .modal-btn.confirm {
      background: #ff3333;
      color: white;
    }
    .modal-btn.confirm:hover {
      background: #ff5555;
    }
    .modal-btn.create {
      background: #ff3333;
      color: white;
    }
    .modal-btn.create:hover {
      background: #ff5555;
    }
    .modal-btn.create:disabled {
      background: #333;
      cursor: not-allowed;
    }
    .friends-container {
      padding: 20px;
      height: 100%;
      overflow-y: auto;
    }
    .friends-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #2a2a2a;
    }
    .friends-header h2 {
      color: #fff;
      font-size: 20px;
    }
    .friends-tabs {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid #2a2a2a;
    }
    .friends-tab {
      padding: 10px 15px;
      background: none;
      border: none;
      color: #b9bbbe;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }
    .friends-tab:hover {
      color: #dcddde;
    }
    .friends-tab.active {
      color: #ff3333;
      border-bottom-color: #ff3333;
    }
    .friend-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin: 5px 0;
      background: #1a1a1a;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .friend-item:hover {
      background: #2a2a2a;
    }
    .friend-name {
      font-weight: 600;
      color: #dcddde;
      font-size: 15px;
    }
    .friend-status {
      font-size: 12px;
      color: #72767d;
      margin-top: 3px;
    }
    .friend-actions {
      display: flex;
      gap: 8px;
    }
    .friend-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s;
    }
    .friend-btn.message {
      background: #ff3333;
      color: white;
    }
    .friend-btn.message:hover {
      background: #ff5555;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(255, 51, 51, 0.3);
    }
    .friend-btn.accept {
      background: #28a745;
      color: white;
    }
    .friend-btn.accept:hover {
      background: #34ce57;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }
    .friend-btn.decline {
      background: #2a2a2a;
      color: #dcddde;
      border: 1px solid #444;
    }
    .friend-btn.decline:hover {
      background: #333;
      border-color: #666;
    }
    .friend-btn.remove {
      background: #2a2a2a;
      color: #ff6b6b;
      border: 1px solid #ff3333;
    }
    .friend-btn.remove:hover {
      background: #dc3545;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }
    .add-friend-section {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .add-friend-section h3 {
      color: #fff;
      font-size: 16px;
      margin-bottom: 12px;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1a1a1a;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(255,0,0,0.4);
      border: 1px solid #2a2a2a;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 250px;
      max-width: 400px;
      animation: slideIn 0.3s ease;
      color: #dcddde;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .toast.success { border-left: 4px solid #ff3333; }
    .toast.error { border-left: 4px solid #ff6666; }
    .toast.warning { border-left: 4px solid #ff9933; }
    .toast.info { border-left: 4px solid #ff3333; }
    .toast-icon {
      font-size: 24px;
      color: #ff3333;
    }
    .toast-message { flex: 1; }
    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 24px;
      height: 24px;
    }
    .toast-close:hover { color: #ff3333; }
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: #0a0a0a;
    }
    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #ff3333;
    }
    .new-dm-btn {
      background: #ff3333;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.3s;
    }
    .new-dm-btn:hover {
      background: #ff5555;
    }
  </style>
</head>
<body>
  <div id="auth">
    <h2>Welcome</h2>
    <input id="username" placeholder="Username" />
    <input id="password" type="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
  </div>
  
  <div id="chat">
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Messages</h3>
        <div class="sidebar-nav">
          <button class="nav-btn" id="friendsBtn">Friends</button>
          <button class="nav-btn" id="settingsBtn">Settings</button>
        </div>
      </div>
      <div style="padding: 8px;">
        <button style="width: 100%; background: #ff3333; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.3s;" id="newDmBtn" onmouseover="this.style.background='#ff5555'" onmouseout="this.style.background='#ff3333'">+ New Chat</button>
      </div>
      <div class="conversations-container" id="conversationsList">
        <div class="empty-state">
          <div class="empty-state-title">No conversations yet</div>
          <div>Start a DM or create a group!</div>
        </div>
      </div>
      <div class="user-info">
        <div class="username-display" id="usernameDisplay"></div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
    
    <div class="main-content">
      <div id="settingsView" style="display:none; height: 100%; overflow-y: auto;">
        <div class="friends-container">
          <div class="friends-header">
            <h2>Settings</h2>
            <button class="new-dm-btn" id="backFromSettingsBtn">← Back</button>
          </div>
          
          <div class="add-friend-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
              <div>
                <div style="font-weight: 600; color: #dcddde; margin-bottom: 5px;">Freedom of Speech</div>
                <div style="font-size: 13px; color: #72767d;">When enabled, non-friends may speak to you</div>
              </div>
              <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                <input type="checkbox" id="allowNonFriendsDM" style="opacity: 0; width: 0; height: 0;">
                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px;"></span>
                <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;"></span>
              </label>
            </div>
          </div>

          <div class="add-friend-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
              <div>
                <div style="font-weight: 600; color: #dcddde; margin-bottom: 5px;">Show Timestamps</div>
                <div style="font-size: 13px; color: #72767d;">Shows timestamps</div>
              </div>
              <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                <input type="checkbox" id="showTimestamps" checked style="opacity: 0; width: 0; height: 0;">
                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px;"></span>
                <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;"></span>
              </label>
            </div>
          </div>

          <div class="add-friend-section" id="adminPanel" style="display:none;">
            <h3 style="color: #ff3333;">Privileges</h3>
            <p style="color: #b9bbbe; font-size: 13px; margin-bottom: 15px;">You are privileged</p>
            <button class="new-dm-btn" id="manageUsersBtn">End them all</button>
          </div>
        </div>
      </div>

      <div id="friendsView" style="display:none; height: 100%; overflow-y: auto;">
        <div class="friends-container">
          <div class="friends-header">
            <h2>Friends</h2>
            <button class="new-dm-btn" id="backToMessagesBtn">← Back</button>
          </div>
          
          <div class="friends-tabs">
            <button class="friends-tab active" data-tab="all">All</button>
            <button class="friends-tab" data-tab="pending">Pending</button>
            <button class="friends-tab" data-tab="add">Add Friend</button>
          </div>
          
          <div id="addFriendTab" style="display:none;">
            <div class="add-friend-section">
              <h3>Add Friend</h3>
              <div style="position: relative;">
                <input id="addFriendInput" class="modal-input" placeholder="" autocomplete="off" />
                <div id="addFriendDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: #1a1a1a; border: 1px solid #333; border-radius: 5px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; margin-top: 5px;">
                </div>
              </div>
            </div>
          </div>
          
          <div id="friendsListContainer"></div>
        </div>
      </div>
      
      <div id="chatView">
        <div class="chat-header" id="chatHeader" style="display:none;">
          <div>
            <div class="chat-title" id="chatTitle"></div>
            <div class="chat-members" id="chatMembers"></div>
          </div>
        </div>
        <div class="messages-container" id="messagesContainer">
          <div class="empty-state">
            <div>click on the buttons</div>
          </div>
        </div>
        <div class="message-input-container" id="messageInputContainer" style="display:none;">
          <div class="message-input-wrapper">
            <input id="messageInput" placeholder="Type a message..." disabled />
            <button id="sendBtn" class="send-btn" disabled>➤</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDocs, where, serverTimestamp, deleteDoc, updateDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzt2lJe_cIK_U7Uh88Wun73dG7GxQMYh4",
      authDomain: "tankaportalv2.firebaseapp.com",
      projectId: "tankaportalv2",
      storageBucket: "tankaportalv2.firebasestorage.app",
      messagingSenderId: "187174097219",
      appId: "1:187174097219:web:0987e83cd8e8d2c101dff6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    let currentConversation = null;
    let currentDMListener = null;
    let conversationsListener = null;
    let friendsListener = null;
    let conversations = new Map();
    let currentFriendsTab = 'all';
    let allUsers = [];
    let userSettings = {
      allowNonFriendsDM: true,
      showTimestamps: true
    };
    const ADMIN_USERNAMES = ['TankaJahari'];
    let unreadCount = 0;
    let lastMessageCounts = new Map();

    function updatePageTitle() {
      const baseTitle = "Chat";
      if (unreadCount > 0) {
        document.title = unreadCount >= 9 ? `${baseTitle} (9+)` : `${baseTitle} (${unreadCount})`;
      } else {
        document.title = baseTitle;
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icons = { success: '✓', error: '✕', warning: '⚠', info: 'ℹ' };
      toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-message">${message}</div>
        <button class="toast-close" onclick="this.parentElement.remove()">×</button>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function fakeEmail(username) {
      return `${username}@chatapp.com`;
    }

    function getConversationId(users) {
      return users.sort().join("_");
    }

    async function loadAllUsers() {
      const usersRef = collection(db, "users");
      const snapshot = await getDocs(usersRef);
      allUsers = [];
      snapshot.forEach(docSnap => {
        const username = docSnap.data().username;
        if (username !== auth.currentUser?.displayName) {
          allUsers.push(username);
        }
      });
    }

    async function loadUserSettings() {
      try {
        const settingsDoc = await getDocs(query(collection(db, "userSettings"), where("userId", "==", auth.currentUser.uid)));
        if (!settingsDoc.empty) {
          const data = settingsDoc.docs[0].data();
          userSettings = { ...userSettings, ...data };
        }
        document.getElementById("allowNonFriendsDM").checked = userSettings.allowNonFriendsDM;
        document.getElementById("showTimestamps").checked = userSettings.showTimestamps;
        
        if (ADMIN_USERNAMES.includes(auth.currentUser.displayName)) {
          const adminPanel = document.getElementById("adminPanel");
          if (adminPanel) {
            adminPanel.style.display = "block";
          }
        }
        
        setupToggleSwitches();
      } catch (error) {
        console.log("Settings load error:", error);
      }
    }

    const manageUsersBtn = document.getElementById("manageUsersBtn");
    if (manageUsersBtn) {
      manageUsersBtn.onclick = showManageUsersModal;
    }

    function showManageUsersModal() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Manage Users (Admin)</div>
          <div class="modal-content">
            <div id="userManagementList" style="max-height: 400px; overflow-y: auto;">
              <p style="color: #72767d; text-align: center;">Loading users...</p>
            </div>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      loadAllUsersForAdmin();
      
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    async function loadAllUsersForAdmin() {
      const usersRef = collection(db, "users");
      const snapshot = await getDocs(usersRef);
      const container = document.getElementById("userManagementList");
      container.innerHTML = '';
      
      snapshot.forEach(docSnap => {
        const username = docSnap.data().username;
        const userId = docSnap.id;
        
        const div = document.createElement('div');
        div.className = 'friend-item';
        div.innerHTML = `
          <div>
            <div class="friend-name">${username}</div>
            <div class="friend-status">UID: ${userId}</div>
          </div>
          <div class="friend-actions">
            <button class="friend-btn remove">Delete User</button>
          </div>
        `;
        
        div.querySelector('.remove').onclick = () => deleteUserAccount(userId, username);
        container.appendChild(div);
      });
    }

    async function deleteUserAccount(userId, username) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Delete User Account</div>
          <div class="modal-content">
            <p style="color:#b9bbbe;">Are you sure you want to delete ${username}?</p>
            <p style="color:#ff6666; font-size: 13px; margin-top: 10px;">Warning: This will delete their user document but NOT their Firebase Auth account. They won't be able to log in with their credentials anymore, but the auth account will still exist in Firebase Auth.</p>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn confirm">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('.confirm').onclick = async () => {
        try {
          await deleteDoc(doc(db, "users", userId));
          
          const friendRequestsRef = collection(db, "friendRequests");
          const friendsSnap = await getDocs(friendRequestsRef);
          friendsSnap.forEach(async (docSnap) => {
            const data = docSnap.data();
            if (data.from === username || data.to === username) {
              await deleteDoc(docSnap.ref);
            }
          });
          
          overlay.remove();
          showToast(`User ${username} deleted`, "success");
          loadAllUsersForAdmin();
        } catch (error) {
          showToast("Failed to delete user", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    function setupToggleSwitches() {
      const switches = ['allowNonFriendsDM', 'showTimestamps'];
      switches.forEach(id => {
        const checkbox = document.getElementById(id);
        const toggle = checkbox.nextElementSibling;
        const slider = toggle.nextElementSibling;
        
        function updateToggle() {
          if (checkbox.checked) {
            toggle.style.backgroundColor = '#ff3333';
            slider.style.transform = 'translateX(26px)';
          } else {
            toggle.style.backgroundColor = '#333';
            slider.style.transform = 'translateX(0)';
          }
        }
        
        updateToggle();
        
        checkbox.onchange = async () => {
          updateToggle();
          userSettings[id] = checkbox.checked;
          try {
            await setDoc(doc(db, "userSettings", auth.currentUser.uid), {
              userId: auth.currentUser.uid,
              ...userSettings
            });
            showToast("Settings saved", "success");
          } catch (error) {
            showToast("Failed to save settings", "error");
          }
        };
      });
    }

    document.getElementById("registerBtn").onclick = async () => {
      try {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        if (!username || !password) {
          showToast("Please enter username and password", "error");
          return;
        }
        if (password.length < 6) {
          showToast("Password must be at least 6 characters", "error");
          return;
        }
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("username", "==", username));
        const snap = await getDocs(q);
        if (!snap.empty) {
          showToast("Username already taken", "error");
          return;
        }
        const email = fakeEmail(username);
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCredential.user, { displayName: username });
        await setDoc(doc(db, "users", userCredential.user.uid), { username });
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
      } catch (error) {
        showToast(error.message, "error");
      }
    };

    document.getElementById("loginBtn").onclick = async () => {
      try {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        if (!username || !password) {
          showToast("Please enter username and password", "error");
          return;
        }
        const email = fakeEmail(username);
        await signInWithEmailAndPassword(auth, email, password);
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
      } catch (error) {
        showToast("Invalid username or password", "error");
      }
    };

    document.getElementById("logoutBtn").onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("auth").style.display = "none";
        document.getElementById("chat").style.display = "flex";
        document.getElementById("usernameDisplay").textContent = user.displayName;
        loadConversations();
        loadUserSettings();
        loadAllUsers();
      } else {
        document.getElementById("auth").style.display = "block";
        document.getElementById("chat").style.display = "none";
        if (currentDMListener) currentDMListener();
        if (conversationsListener) conversationsListener();
        if (friendsListener) friendsListener();
        conversations.clear();
        currentConversation = null;
        allUsers = [];
      }
    });

    function loadConversations() {
      const currentUser = auth.currentUser.displayName;
      const dmsRef = collection(db, "dms");
      conversationsListener = onSnapshot(dmsRef, async snapshot => {
        conversations.clear();
        unreadCount = 0;
        
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          if (data.members && data.members.includes(currentUser)) {
            const convId = docSnap.id;
            conversations.set(convId, {
              id: convId,
              members: data.members,
              groupName: data.groupName || null,
              lastMessage: data.lastMessage || null
            });
            
            // Count unread messages for conversations that aren't currently open
            if (convId !== currentConversation) {
              const messagesRef = collection(db, "dms", convId, "messages");
              const messagesSnapshot = await getDocs(messagesRef);
              const currentCount = messagesSnapshot.size;
              const lastCount = lastMessageCounts.get(convId) || 0;
              
              if (currentCount > lastCount) {
                unreadCount += (currentCount - lastCount);
              }
              
              lastMessageCounts.set(convId, currentCount);
            }
          }
        }
        
        updateConversationsList();
        updatePageTitle();
      });
    }

    function updateConversationsList() {
      const container = document.getElementById("conversationsList");
      container.innerHTML = "";
      if (conversations.size === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-title">No conversations yet</div>
            <div>Start a DM or create a group!</div>
          </div>
        `;
        return;
      }
      conversations.forEach(conv => {
        const div = document.createElement("div");
        div.className = "conversation-item";
        if (currentConversation === conv.id) div.classList.add("active");
        
        const currentUser = auth.currentUser.displayName;
        const otherMembers = conv.members.filter(m => m !== currentUser);
        const displayName = conv.groupName || otherMembers.join(", ");
        const isGroup = conv.members.length > 2;
        
        let html = `
          <div class="conversation-info">
            <div class="conversation-name">${isGroup ? 'Group: ' : ''}${displayName}</div>
        `;
        
        if (isGroup) {
          html += `<div class="conversation-members">${conv.members.length} members</div>`;
        }
        
        html += `
          </div>
          <button class="delete-conversation">×</button>
        `;
        
        div.innerHTML = html;
        
        div.querySelector(".conversation-info").onclick = () => selectConversation(conv.id);
        div.querySelector(".delete-conversation").onclick = (e) => {
          e.stopPropagation();
          if (isGroup) {
            leaveConversation(conv.id);
          } else {
            deleteConversation(conv.id);
          }
        };
        
        container.appendChild(div);
      });
    }

    function selectConversation(conversationId) {
      currentConversation = conversationId;
      const conv = conversations.get(conversationId);
      const currentUser = auth.currentUser.displayName;
      const otherMembers = conv.members.filter(m => m !== currentUser);
      const displayName = conv.groupName || otherMembers.join(", ");
      const isGroup = conv.members.length > 2;
      
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("chatView").style.flexDirection = "column";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      
      document.getElementById("chatHeader").style.display = "flex";
      document.getElementById("chatTitle").textContent = (isGroup ? 'Group: ' : '') + displayName;
      
      if (isGroup) {
        document.getElementById("chatMembers").textContent = conv.members.join(", ");
      } else {
        document.getElementById("chatMembers").textContent = "";
      }
      
      document.getElementById("messageInputContainer").style.display = "block";
      document.getElementById("messageInput").disabled = false;
      document.getElementById("sendBtn").disabled = false;
      
      // Mark current conversation as read
      const messagesRef = collection(db, "dms", conversationId, "messages");
      getDocs(messagesRef).then(snapshot => {
        lastMessageCounts.set(conversationId, snapshot.size);
        // Recalculate unread count
        unreadCount = 0;
        lastMessageCounts.forEach((count, convId) => {
          if (convId !== currentConversation) {
            const conv = conversations.get(convId);
            if (conv) {
              getDocs(collection(db, "dms", convId, "messages")).then(snap => {
                const newCount = snap.size;
                if (newCount > count) {
                  unreadCount += (newCount - count);
                  updatePageTitle();
                }
              });
            }
          }
        });
        updatePageTitle();
      });
      
      updateConversationsList();
      startDM(conversationId);
    }

    function startDM(conversationId) {
      if (currentDMListener) currentDMListener();
      const q = query(collection(db, "dms", conversationId, "messages"), orderBy("createdAt", "asc"));
      currentDMListener = onSnapshot(q, snapshot => {
        const container = document.getElementById("messagesContainer");
        container.innerHTML = "";
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement("div");
          div.className = "message";
          if (data.from === auth.currentUser?.displayName) {
            div.classList.add("own");
          }
          
          let timestamp = "";
          if (data.createdAt && userSettings.showTimestamps) {
            const date = data.createdAt.toDate();
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            
            if (isToday) {
              timestamp = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            } else {
              timestamp = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + 
                         date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }
          }
          
          div.innerHTML = `
            <div class="message-header">
              <div class="message-author">${data.from}</div>
              <div class="message-timestamp">${timestamp}</div>
            </div>
            <div class="message-text">${data.text}</div>
          `;
          container.appendChild(div);
        });
        
        setTimeout(() => {
          container.scrollTop = 999999;
        }, 50);
      });
    }

    document.getElementById("sendBtn").onclick = sendMessage;
    document.getElementById("messageInput").onkeypress = (e) => {
      if (e.key === 'Enter') sendMessage();
    };

    async function sendMessage() {
      const text = document.getElementById("messageInput").value.trim();
      if (!currentConversation || !text) return;
      const conv = conversations.get(currentConversation);
      try {
        await setDoc(doc(db, "dms", currentConversation), {
          members: conv.members,
          groupName: conv.groupName || null,
          lastMessage: text,
          lastMessageTime: serverTimestamp()
        }, { merge: true });
        await addDoc(collection(db, "dms", currentConversation, "messages"), {
          from: auth.currentUser.displayName,
          text,
          createdAt: serverTimestamp()
        });
        document.getElementById("messageInput").value = "";
      } catch (error) {
        showToast("Failed to send message", "error");
      }
    }

    document.getElementById("friendsBtn").onclick = () => {
      document.getElementById("chatView").style.display = "none";
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("friendsView").style.display = "block";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById("friendsBtn").classList.add('active');
      loadFriends();
    };

    document.getElementById("settingsBtn").onclick = () => {
      document.getElementById("chatView").style.display = "none";
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("settingsView").style.display = "block";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById("settingsBtn").classList.add('active');
    };

    document.getElementById("newDmBtn").onclick = () => {
      showNewDmModal();
    };

    document.getElementById("backToMessagesBtn").onclick = () => {
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("chatView").style.flexDirection = "column";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    };

    document.getElementById("backFromSettingsBtn").onclick = () => {
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("chatView").style.flexDirection = "column";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    };

    document.querySelectorAll('.friends-tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.friends-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFriendsTab = tab.dataset.tab;
        if (currentFriendsTab === 'add') {
          document.getElementById('addFriendTab').style.display = 'block';
          document.getElementById('friendsListContainer').innerHTML = '';
        } else {
          document.getElementById('addFriendTab').style.display = 'none';
          loadFriends();
        }
      };
    });

    const addFriendInput = document.getElementById("addFriendInput");
    const addFriendDropdown = document.getElementById("addFriendDropdown");

    addFriendInput.oninput = () => {
      const searchTerm = addFriendInput.value.trim().toLowerCase();
      
      if (searchTerm.length === 0) {
        addFriendDropdown.style.display = 'none';
        return;
      }

      const matches = allUsers.filter(user => 
        user.toLowerCase().includes(searchTerm)
      );

      if (matches.length === 0) {
        addFriendDropdown.innerHTML = '<div class="user-select-item">No users found</div>';
        addFriendDropdown.style.display = 'block';
        return;
      }

      addFriendDropdown.innerHTML = '';
      matches.forEach(username => {
        const div = document.createElement('div');
        div.className = 'user-select-item';
        div.textContent = username;
        div.onclick = async () => {
          addFriendInput.value = "";
          addFriendDropdown.style.display = 'none';
          
          if (username === auth.currentUser.displayName) {
            showToast("You can't add yourself as a friend!", "warning");
            return;
          }
          
          try {
            const friendRequestId = [auth.currentUser.displayName, username].sort().join("_");
            await setDoc(doc(db, "friendRequests", friendRequestId), {
              from: auth.currentUser.displayName,
              to: username,
              status: "pending",
              createdAt: serverTimestamp()
            });
            showToast("Friend request sent!", "success");
          } catch (error) {
            showToast("Failed to send friend request", "error");
          }
        };
        addFriendDropdown.appendChild(div);
      });

      addFriendDropdown.style.display = 'block';
    };

    document.addEventListener('click', (e) => {
      if (!addFriendInput.contains(e.target) && !addFriendDropdown.contains(e.target)) {
        addFriendDropdown.style.display = 'none';
      }
    });

    function loadFriends() {
      const currentUser = auth.currentUser.displayName;
      
      if (friendsListener) friendsListener();
      
      const friendRequestsRef = collection(db, "friendRequests");
      friendsListener = onSnapshot(friendRequestsRef, snapshot => {
        const friends = [];
        const pending = [];
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.from === currentUser || data.to === currentUser) {
            if (data.status === "accepted") {
              const friendName = data.from === currentUser ? data.to : data.from;
              friends.push({ username: friendName, id: docSnap.id });
            } else if (data.status === "pending") {
              if (data.to === currentUser) {
                pending.push({ username: data.from, id: docSnap.id, type: 'incoming' });
              } else {
                pending.push({ username: data.to, id: docSnap.id, type: 'outgoing' });
              }
            }
          }
        });
        
        displayFriendsList(friends, pending);
      });
    }

    function displayFriendsList(friends, pending) {
      const container = document.getElementById("friendsListContainer");
      container.innerHTML = "";
      
      if (currentFriendsTab === 'all') {
        if (friends.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No friends yet</div><div>Add some friends to get started!</div></div>';
          return;
        }
        friends.forEach(friend => {
          const div = document.createElement('div');
          div.className = 'friend-item';
          div.innerHTML = `
            <div>
              <div class="friend-name">${friend.username}</div>
              <div class="friend-status">Friend</div>
            </div>
            <div class="friend-actions">
              <button class="friend-btn message">Message</button>
              <button class="friend-btn remove">Remove</button>
            </div>
          `;
          div.querySelector('.message').onclick = () => startDMWithFriend(friend.username);
          div.querySelector('.remove').onclick = () => removeFriend(friend.id);
          container.appendChild(div);
        });
      } else if (currentFriendsTab === 'pending') {
        if (pending.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No pending requests</div></div>';
          return;
        }
        pending.forEach(request => {
          const div = document.createElement('div');
          div.className = 'friend-item';
          if (request.type === 'incoming') {
            div.innerHTML = `
              <div>
                <div class="friend-name">${request.username}</div>
                <div class="friend-status">Incoming friend request</div>
              </div>
              <div class="friend-actions">
                <button class="friend-btn accept">Accept</button>
                <button class="friend-btn decline">Decline</button>
              </div>
            `;
            div.querySelector('.accept').onclick = () => acceptFriendRequest(request.id);
            div.querySelector('.decline').onclick = () => declineFriendRequest(request.id);
          } else {
            div.innerHTML = `
              <div>
                <div class="friend-name">${request.username}</div>
                <div class="friend-status">Outgoing friend request</div>
              </div>
              <div class="friend-actions">
                <button class="friend-btn decline">Cancel</button>
              </div>
            `;
            div.querySelector('.decline').onclick = () => declineFriendRequest(request.id);
          }
          container.appendChild(div);
        });
      }
    }

    async function acceptFriendRequest(requestId) {
      try {
        await setDoc(doc(db, "friendRequests", requestId), {
          status: "accepted"
        }, { merge: true });
        showToast("Friend request accepted!", "success");
      } catch (error) {
        showToast("Failed to accept request", "error");
      }
    }

    async function declineFriendRequest(requestId) {
      try {
        await deleteDoc(doc(db, "friendRequests", requestId));
        showToast("Request removed", "success");
      } catch (error) {
        showToast("Failed to remove request", "error");
      }
    }

    async function removeFriend(friendId) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Remove Friend</div>
          <div class="modal-content">
            <p style="color:#b9bbbe;">Are you sure you want to remove this friend?</p>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn confirm">Remove</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('.confirm').onclick = async () => {
        try {
          await deleteDoc(doc(db, "friendRequests", friendId));
          overlay.remove();
          showToast("Friend removed", "success");
        } catch (error) {
          showToast("Failed to remove friend", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    async function startDMWithFriend(friendUsername) {
      document.getElementById("friendsView").style.display = "none";
      document.getElementById("settingsView").style.display = "none";
      document.getElementById("chatView").style.display = "flex";
      document.getElementById("chatView").style.flexDirection = "column";
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      
      const members = [auth.currentUser.displayName, friendUsername];
      const conversationId = getConversationId(members);
      
      if (!conversations.has(conversationId)) {
        try {
          await setDoc(doc(db, "dms", conversationId), {
            members,
            groupName: null,
            createdAt: serverTimestamp()
          });
        } catch (error) {
          showToast("Failed to start conversation", "error");
          return;
        }
      }
      
      setTimeout(() => {
        const items = document.querySelectorAll('.conversation-item');
        items.forEach(item => {
          const nameElem = item.querySelector('.conversation-name');
          if (nameElem && nameElem.textContent === friendUsername) {
            item.querySelector('.conversation-info').click();
          }
        });
      }, 500);
    }

    function showNewDmModal() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Create new message</div>
          <div class="modal-content">
            <label class="modal-label">Group name</label>
            <input type="text" class="modal-input" id="groupNameInput" placeholder="Leave empty for DM" />
            
            <label class="modal-label">Choose the people you want to talk to</label>
            <div style="position: relative;">
              <input type="text" class="modal-input" id="userSearchInput" placeholder="" autocomplete="off" />
              <div id="userSearchDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: #1a1a1a; border: 1px solid #333; border-radius: 5px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; margin-top: 5px;">
              </div>
            </div>
            
            <div class="selected-users" id="selectedUsersList"></div>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn create" id="createConvBtn">Create</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      loadFriendsForModal();
      
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    async function loadFriendsForModal() {
      const currentUser = auth.currentUser.displayName;
      const friendRequestsRef = collection(db, "friendRequests");
      const snapshot = await getDocs(friendRequestsRef);
      
      let friendsList = [];
      
      if (userSettings.allowNonFriendsDM) {
        friendsList = allUsers;
      } else {
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.status === "accepted") {
            if (data.from === currentUser) {
              friendsList.push(data.to);
            } else if (data.to === currentUser) {
              friendsList.push(data.from);
            }
          }
        });
      }
      
      const selectedUsers = new Set();
      const userSearchInput = document.getElementById('userSearchInput');
      const userSearchDropdown = document.getElementById('userSearchDropdown');
      const selectedUsersList = document.getElementById('selectedUsersList');
      
      userSearchInput.oninput = () => {
        const searchTerm = userSearchInput.value.trim().toLowerCase();
        
        if (searchTerm.length === 0) {
          userSearchDropdown.style.display = 'none';
          return;
        }

        const matches = friendsList.filter(user => 
          user.toLowerCase().includes(searchTerm) && !selectedUsers.has(user)
        );

        if (matches.length === 0) {
          userSearchDropdown.innerHTML = '<div class="user-select-item">No users found</div>';
          userSearchDropdown.style.display = 'block';
          return;
        }

        userSearchDropdown.innerHTML = '';
        matches.forEach(username => {
          const div = document.createElement('div');
          div.className = 'user-select-item';
          div.textContent = username;
          div.onclick = () => {
            selectedUsers.add(username);
            updateSelectedUsers();
            userSearchInput.value = '';
            userSearchDropdown.style.display = 'none';
          };
          userSearchDropdown.appendChild(div);
        });

        userSearchDropdown.style.display = 'block';
      };
      
      function updateSelectedUsers() {
        selectedUsersList.innerHTML = '';
        selectedUsers.forEach(username => {
          const tag = document.createElement('div');
          tag.className = 'selected-user-tag';
          tag.innerHTML = `
            ${username}
            <button class="remove-user">×</button>
          `;
          tag.querySelector('.remove-user').onclick = () => {
            selectedUsers.delete(username);
            updateSelectedUsers();
          };
          selectedUsersList.appendChild(tag);
        });
      }
      
      document.getElementById('createConvBtn').onclick = async () => {
        if (selectedUsers.size === 0) {
          showToast("Please select at least one user", "warning");
          return;
        }
        const groupName = document.getElementById('groupNameInput').value.trim();
        const members = [auth.currentUser.displayName, ...Array.from(selectedUsers)];
        const conversationId = getConversationId(members);
        
        try {
          await setDoc(doc(db, "dms", conversationId), {
            members,
            groupName: members.length > 2 ? (groupName || null) : null,
            createdAt: serverTimestamp()
          });
          document.querySelector('.modal-overlay').remove();
          showToast("Conversation created!", "success");
        } catch (error) {
          showToast("Failed to create conversation", "error");
        }
      };
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function closeDropdown(e) {
        if (!userSearchInput.contains(e.target) && !userSearchDropdown.contains(e.target)) {
          userSearchDropdown.style.display = 'none';
        }
        // Remove listener when modal is closed
        const modal = document.querySelector('.modal-overlay');
        if (!modal) {
          document.removeEventListener('click', closeDropdown);
        }
      });
    }

    function leaveConversation(conversationId) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Leave Group</div>
          <div class="modal-content">
            <p style="color:#b9bbbe;">Are you sure you want to leave this group?</p>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn confirm">Leave</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('.confirm').onclick = async () => {
        try {
          const currentUser = auth.currentUser.displayName;
          await updateDoc(doc(db, "dms", conversationId), {
            members: arrayRemove(currentUser)
          });
          
          if (currentConversation === conversationId) {
            currentConversation = null;
            document.getElementById("chatHeader").style.display = "none";
            document.getElementById("messageInputContainer").style.display = "none";
            document.getElementById("messagesContainer").innerHTML = `
              <div class="empty-state">
                <div>click on the buttons</div>
              </div>
            `;
          }
          overlay.remove();
          showToast("Left the group", "success");
        } catch (error) {
          showToast("Failed to leave group", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }

    function deleteConversation(conversationId) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `
        <div class="modal">
          <div class="modal-title">Delete Conversation</div>
          <div class="modal-content">
            <p style="color:#b9bbbe;">This will remove all messages. Are you sure?</p>
          </div>
          <div class="modal-buttons">
            <button class="modal-btn cancel">Cancel</button>
            <button class="modal-btn confirm">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('.cancel').onclick = () => overlay.remove();
      overlay.querySelector('.confirm').onclick = async () => {
        try {
          const messagesRef = collection(db, "dms", conversationId, "messages");
          const messagesSnap = await getDocs(messagesRef);
          await Promise.all(messagesSnap.docs.map(d => deleteDoc(d.ref)));
          await deleteDoc(doc(db, "dms", conversationId));
          if (currentConversation === conversationId) {
            currentConversation = null;
            document.getElementById("chatHeader").style.display = "none";
            document.getElementById("messageInputContainer").style.display = "none";
            document.getElementById("messagesContainer").innerHTML = `
              <div class="empty-state">
                <div>click on the buttons</div>
              </div>
            `;
          }
          overlay.remove();
          showToast("Conversation deleted", "success");
        } catch (error) {
          showToast("Failed to delete conversation", "error");
        }
      };
      overlay.onclick = (e) => {
        if (e.target === overlay) overlay.remove();
      };
    }
  </script>
</body>
</html>
